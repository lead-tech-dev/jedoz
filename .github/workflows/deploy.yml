name: deploy

on:
  push:
    branches: [main, staging, dev]
  workflow_dispatch:
    inputs:
      environment:
        description: "Environment (dev/staging/prod)"
        required: true
        default: "prod"
      git_ref:
        description: "Git ref/branch to deploy (optional)"
        required: false
        default: ""

jobs:
  build-deploy-static:
    runs-on: ubuntu-latest
    environment: ${{ inputs.environment || (github.ref_name == 'main' && 'prod' || github.ref_name == 'staging' && 'staging' || 'dev') }}
    env:
      DEPLOY_ENV: ${{ inputs.environment || (github.ref_name == 'main' && 'prod' || github.ref_name == 'staging' && 'staging' || 'dev') }}
      DEPLOY_REF: ${{ inputs.git_ref != '' && inputs.git_ref || github.ref_name }}
    steps:
      - uses: actions/checkout@v4
      - uses: pnpm/action-setup@v4
        with:
          run_install: false
      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: pnpm
      - name: Set environment URLs
        run: |
          if [ "${DEPLOY_ENV}" = "prod" ]; then
            echo "API_URL=https://api.jedoz.com" >> $GITHUB_ENV
          elif [ "${DEPLOY_ENV}" = "staging" ]; then
            echo "API_URL=https://api.staging.jedoz.com" >> $GITHUB_ENV
          else
            echo "API_URL=https://api.dev.jedoz.com" >> $GITHUB_ENV
          fi
      - name: Install
        run: pnpm install --no-frozen-lockfile
      - name: Build web
        env:
          VITE_API_URL: ${{ env.API_URL }}
        run: pnpm --filter web build
      - name: Build admin
        env:
          VITE_API_BASE: ${{ env.API_URL }}
        run: pnpm --filter admin build
      - name: Configure SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.VPS_SSH_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H "${{ secrets.VPS_HOST }}" >> ~/.ssh/known_hosts
      - name: Deploy web/admin to VPS
        run: |
          WEB_DIR="${{ secrets.VPS_WEB_DIR }}"
          ADMIN_DIR="${{ secrets.VPS_ADMIN_DIR }}"
          if [ -z "$WEB_DIR" ]; then WEB_DIR="/var/www/jedoz/${DEPLOY_ENV}/web"; fi
          if [ -z "$ADMIN_DIR" ]; then ADMIN_DIR="/var/www/jedoz/${DEPLOY_ENV}/admin"; fi
          ssh -o StrictHostKeyChecking=yes "${{ secrets.VPS_SSH_USER }}@${{ secrets.VPS_HOST }}" "mkdir -p '$WEB_DIR' '$ADMIN_DIR'"
          rsync -az --delete apps/web/dist/ "${{ secrets.VPS_SSH_USER }}@${{ secrets.VPS_HOST }}:$WEB_DIR/"
          rsync -az --delete apps/admin/dist/ "${{ secrets.VPS_SSH_USER }}@${{ secrets.VPS_HOST }}:$ADMIN_DIR/"

  deploy-api:
    runs-on: ubuntu-latest
    environment: ${{ inputs.environment || (github.ref_name == 'main' && 'prod' || github.ref_name == 'staging' && 'staging' || 'dev') }}
    env:
      DEPLOY_ENV: ${{ inputs.environment || (github.ref_name == 'main' && 'prod' || github.ref_name == 'staging' && 'staging' || 'dev') }}
      DEPLOY_REF: ${{ inputs.git_ref != '' && inputs.git_ref || github.ref_name }}
    needs: build-deploy-static
    steps:
      - uses: actions/checkout@v4
      - name: Deploy via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_SSH_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          script: |
            set -e
            APP_DIR=${{ secrets.VPS_APP_DIR }}
            if [ -z "$APP_DIR" ]; then APP_DIR="/var/www/jedoz/${DEPLOY_ENV}/app"; fi
            if [ ! -d "$APP_DIR/.git" ]; then
              mkdir -p "$APP_DIR"
              git clone ${{ secrets.API_GIT_URL || github.repositoryUrl }} "$APP_DIR"
            fi
            cd "$APP_DIR"
            git fetch --all
            git reset --hard origin/${DEPLOY_REF}
            corepack enable || true
            corepack prepare pnpm@9.12.1 --activate || true
            pnpm install --no-frozen-lockfile
            pnpm --filter api exec prisma generate
            pnpm --filter api exec prisma migrate deploy
            sudo systemctl restart jedoz-api@${DEPLOY_ENV}
            sudo systemctl restart jedoz-worker@${DEPLOY_ENV}

  notify:
    runs-on: ubuntu-latest
    if: always()
    needs: [build-deploy-static, deploy-api]
    env:
      DEPLOY_ENV: ${{ inputs.environment || (github.ref_name == 'main' && 'prod' || github.ref_name == 'staging' && 'staging' || 'dev') }}
    steps:
      - name: Notify Slack
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        run: |
          if [ -z "${SLACK_WEBHOOK_URL}" ]; then
            echo "SLACK_WEBHOOK_URL not set; skipping Slack notification."
            exit 0
          fi
          status="success"
          if [ "${{ needs.build-deploy-static.result }}" != "success" ] || [ "${{ needs.deploy-api.result }}" != "success" ]; then
            status="failure"
          fi
          commit_msg="${{ github.event.head_commit.message }}"
          commit_sha="${GITHUB_SHA}"
          commit_short="$(printf "%s" "$commit_sha" | cut -c1-7)"
          run_url="https://github.com/${GITHUB_REPOSITORY}/actions/runs/${GITHUB_RUN_ID}"
          commit_msg="${commit_msg//$'\n'/ }"
          commit_msg="${commit_msg//\"/\\\"}"
          if [ "${DEPLOY_ENV}" = "prod" ]; then
            web_url="https://jedoz.com"
            admin_url="https://admin.jedoz.com"
            api_url="https://api.jedoz.com/health"
          elif [ "${DEPLOY_ENV}" = "staging" ]; then
            web_url="https://staging.jedoz.com"
            admin_url="https://admin.staging.jedoz.com"
            api_url="https://api.staging.jedoz.com/health"
          else
            web_url="https://dev.jedoz.com"
            admin_url="https://admin.dev.jedoz.com"
            api_url="https://api.dev.jedoz.com/health"
          fi
          job_web="${{ needs.build-deploy-static.result }}"
          job_api="${{ needs.deploy-api.result }}"
          if [ "$status" = "success" ]; then
            color="#2eb886"
            emoji="✅"
          else
            color="#e01e5a"
            emoji="❌"
          fi
          payload=$(cat <<EOF
          {
            "attachments": [
              {
                "color": "${color}",
                "blocks": [
                  {
                    "type": "header",
                    "text": {
                      "type": "plain_text",
                      "text": "${emoji} Deploy ${DEPLOY_ENV} (${GITHUB_REF_NAME}) - ${status}"
                    }
                  },
                  {
                    "type": "section",
                    "fields": [
                      { "type": "mrkdwn", "text": "*Repo:* ${GITHUB_REPOSITORY}" },
                      { "type": "mrkdwn", "text": "*Actor:* ${GITHUB_ACTOR}" },
                      { "type": "mrkdwn", "text": "*Web:* ${web_url}" },
                      { "type": "mrkdwn", "text": "*Admin:* ${admin_url}" },
                      { "type": "mrkdwn", "text": "*API:* ${api_url}" },
                      { "type": "mrkdwn", "text": "*Jobs:* web/admin=${job_web}, api=${job_api}" }
                    ]
                  },
                  {
                    "type": "section",
                    "text": { "type": "mrkdwn", "text": "*Commit:* ${commit_short} - ${commit_msg}" }
                  },
                  {
                    "type": "section",
                    "text": { "type": "mrkdwn", "text": "*Run:* ${run_url}" }
                  }
                ]
              }
            ]
          }
          EOF
          )
          curl -X POST -H 'Content-type: application/json' --data "$payload" "${SLACK_WEBHOOK_URL}"
